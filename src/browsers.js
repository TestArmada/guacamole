var Q = require("q");
var _ = require("lodash");
var request = require("request");
var browsers = [];

var capabilityFields = [
  "browserName",          // i.e.: "firefox", "chrome", but also (strangely) "android"
  "version",              // i.e.: "42.0"

  "platform",             // i.e.: "OS X 10.10"
                          // NOTE:
                          // We perform some transformations from the listing API to 
                          // sauce's device capabilities API, i.e.: "Mac 10.10" -> "OS X 10.10".

  "deviceName",           // i.e: "Samsung Galaxy S5 Device".
                          // NOTE:
                          // As with platform, we transform some strings from the listing API
                          // on their way to the device capabilities API. For example, if the saucelabs
                          // listing API specifies a device field but does NOT have the word "device"
                          // in it, it's assumed to be an simulator, and we perform a transformation,
                          // i.e.: "iphone" -> "iPhone Simulator", "Mac <version>" -> "OS X <version>", etc.

  "platformVersion",      // i.e.: "4.4"
  "platformName",         // i.e.: "Android"

  "screenResolution",     // i.e. "1024x768" or undefined. Generated by this module (if matched and requested)
  "deviceOrientation"     // i.e. "landscape" or undefined. Generated by this module (if matched and requested)
];

// Fields Proprietary to this Module
/*
  "id"                    Alias for a browser such as chrome_43_Windows_2012_R2_Desktop
  "family"                For use in sorting or grouping browsers, i.e.: "IE", "Chrome", etc.
  "resolutions"           Array of valid values for "screenResolution"
*/

var SauceBrowsers = {

  // NOTE: The URL https://saucelabs.com/rest/v1/info/platforms/webdriver has this
  // information, but not the available resolutions. That's why we go to the endpoint 
  // with the much larger set of options (+ automation backends) and then filter down.
  SAUCE_URL: "https://saucelabs.com/rest/v1/info/platforms/all?resolutions=true",
  _haveCachedSauceBrowsers: false,

  filter: function (fn) {
    return browsers.filter(fn);
  },

  // Return a browser's deviceCapabilities object by id if it exists in our browser list.
  // Optionally, we also:
  // 1) Match a supported resolution if its supported, and return a browser with that screenResolution set
  // 2) Set an orientiation if specified.
  get: function (id, resolution, orientation) {
    var browser;

    if (!_.isString(id)) return;

    id = id.trim();

    browsers.forEach(function (b) {
      if (b.id === id && !browser) {
        // If we've requested a display size, verify it exists
        if (resolution) {
          if (b.resolutions && b.resolutions.indexOf(resolution) > -1) {
            browser = b;
          }
        } else {
          browser = b;
        }
      }
    });

    var result;

    // Extend deviceCapabilities with some properties which aren't fixed in the saucelabs list,
    // but may be supported by deviceCapabilities.
    if (browser) {
      result = _.extend({}, browser.deviceCapabilities);

      if (orientation) {
        result.deviceOrientation = orientation;
      }

      if (resolution) {
        result.screenResolution = resolution;
      }
    }

    return result;
  },

  _normalize: function (data) {
    var result = data
      .filter(function (browser) {
        return browser.automation_backend === "webdriver";
      })
      .map(function (browser) {
        var name = browser.api_name;

        if (name === "internet explorer") {
          name = "IE";
        }

        var family;
        if (name === "IE") {
          family = "IE";
        } else if (name.indexOf("android") === 0) {
          family = "Webkit Android";
        } else if (name.indexOf("firefox") === 0) {
          family = "Firefox (Gecko)";
        } else if (name.indexOf("ipad") === 0) {
          family = "Webkit iPad";
        } else if (name.indexOf("iphone") === 0) {
          family = "Webkit iPhone";
        } else if (name.indexOf("opera") === 0) {
          family = "Opera";
        } else if (name.indexOf("safari") === 0) {
          family = "Webkit Safari";
        } else if (name.indexOf("chrome") === 0) {
          family = "Chrome";
        } else {
          family = "Other";
        }

        var clean = function (str) { return str.split(" ").join("_").split(".").join("_"); };

        var deviceName = (browser.device ? browser.device : "Desktop");
        var osName = browser.os;

        // For a real device, don't translate to a simulator devicename
        if (deviceName.toLowerCase().indexOf("device") === -1) {
          if (deviceName.toLowerCase() == "ipad") {
            deviceName = "iPad Simulator";
            osName = "iOS";
          }

          if(deviceName.toLowerCase() == "iphone") {
            deviceName = "iPhone Simulator";
            osName = "iOS";
          }

          if(deviceName.toLowerCase() == "android") {
            deviceName = "Android Simulator";
          }
        }

        if (osName.indexOf("Mac") === 0) {
          osName = osName.replace("Mac", "OS X");
        }

        var result = {
          // name , version, OS, device
          id: (
            clean(name)
            + "_" + clean(browser.short_version)
            + "_" + clean(osName)
            + "_" + clean(deviceName)
          ),
          browserName: browser.api_name,
          version: browser.short_version,
          platform: osName,
          family: family,
          resolutions: browser.resolutions
        };

        if (deviceName.toLowerCase().indexOf("android") > -1) {
          result.platformVersion = browser.short_version || browser.version;
          result.platformName = osName;
        }

        // Note: we only set the device property if we have a non-desktop device. This is because
        // SauceLabs doesn't actually have a "Desktop" device, we're just making one up for UX.
        if (deviceName !== "Desktop") {
          // this is a mobile device as opposed to a desktop browser.
          result.deviceName = deviceName;
        }

        return result;
      }).map(function (browser) {
        var result = {
          id: browser.id,
          family: browser.family,
          resolutions: browser.resolutions,
          deviceCapabilities: {}
        };

        capabilityFields.forEach(function (field) {
          if (browser[field]) {
            result.deviceCapabilities[field] = browser[field];
          }
        });

        return result;
      });

    return _.sortBy(result, function (browser) { return browser.id; });
  },

  // Fetch a raw list of browsers from the Sauce API
  _fetch: function () {
    var deferred = Q.defer();

    request(this.SAUCE_URL, function (err, data) {
      if (err) {
        deferred.reject(err);
      } else {
        try {
          data = JSON.parse(data.body);
        } catch (e) {
          deferred.reject(e);
          return;
        }
        deferred.resolve(data);
      }
    });

    return deferred.promise;
  },

  // Return a promise that we'll build a list of supported browsers
  initialize: function () {
    var deferred = Q.defer();
    var self = this;

    if (this._haveCachedSauceBrowsers) {
      deferred.resolve();
      return deferred.promise;
    }

    this._fetch()
      .then(function (data) {
        self._haveCachedSauceBrowsers = true;
        browsers = self._normalize(data);

        deferred.resolve();
      })
      .catch(function (err) {
        deferred.reject(err);
      });

    return deferred.promise;
  }
};

SauceBrowsers._normalize = SauceBrowsers._normalize.bind(SauceBrowsers);

module.exports = SauceBrowsers;